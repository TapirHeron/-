package org.example.backend.controller;

import com.alibaba.fastjson.JSONObject;
import jakarta.validation.constraints.NotNull;
import org.example.backend.pojo.Response.AnalysisResponse;
import org.example.backend.pojo.UserTransData;
import org.example.backend.service.IDataService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.io.File;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.HashMap;

@CrossOrigin(origins = "*", maxAge = 3600)
@RestController
@RequestMapping("/data")
public class DataController {
    @Autowired
    private IDataService dataService;
    @RequestMapping("/uploadData")
    public AnalysisResponse uploadData(@RequestPart("image") MultipartFile image, @RequestParam("text") String text) throws Exception {
//        System.out.println("userTransData: " + image + "text: " + text);
//        String imagePath = storeFile(image);
//        UserTransData userTransData = new UserTransData(UserController.getCurrentUser().getUserId(), imagePath, text);
//        return dataService.saveAndAnalysis(userTransData);
          AnalysisResponse analysisResponse = new AnalysisResponse(JSONObject.parseObject("{\"logits_multicls\":[[0.5895001292228699,0.1958199143409729,0.4782300591468811,0.7827669978141785]],\"file_path\":\"uploads\\\\1744642978035_.jpg\",\"output_coord\":[[0.5844021439552307,0.29542025923728943,0.5728709101676941,0.4759475588798523]],\"probs_real_fake\":[[0.24274654686450958,0.08839557319879532]],\"logits_tok\":[[[-0.08063624799251556,-0.019094914197921753],[-0.03966306149959564,-0.07805934548377991],[-0.06281019747257233,0.004548221826553345],[-0.09012684226036072,0.12369886040687561],[-0.027374625205993652,0.10019621253013611],[-0.083528071641922,-0.04649853706359863],[-0.0607900470495224,-0.01678156852722168],[0.09067139029502869,0.03817746043205261],[-0.10292594134807587,0.15873372554779053],[-0.0010779350996017456,0.10717543959617615],[0.08741258084774017,-0.021346628665924072],[0.00579814612865448,0.020991921424865723],[0.13284693658351898,-0.04375159740447998],[0.06336408853530884,0.013353884220123291],[-0.11318887770175934,0.0895029604434967],[0.003918811678886414,0.045455873012542725],[-0.15339508652687073,0.06992080807685852],[0.0011118948459625244,0.15478463470935822],[0.04810495674610138,0.09488332271575928],[-0.1422339826822281,0.08399307727813721],[-0.026924550533294678,0.030858740210533142],[-0.11373013257980347,0.002798795700073242],[-0.22276988625526428,0.14914056658744812],[0.03460472822189331,0.08760683238506317],[-0.12085223197937012,-0.020504876971244812],[-0.16413357853889465,-0.010414659976959229],[-0.01634400337934494,-0.16056187450885773],[-0.13696788251399994,-0.06531824171543121],[-0.13197796046733856,0.04983559250831604],[-0.21288233995437622,0.07670196890830994],[-0.314583957195282,0.0594942569732666],[-0.08167102932929993,0.02087344229221344],[-0.09107613563537598,0.055509015917778015],[-0.21504032611846924,0.1837599128484726],[-0.16950885951519012,0.12767216563224792],[-0.24214580655097961,0.034564390778541565],[-0.23916195333003998,0.07370735704898834],[-0.13807162642478943,0.06114743649959564],[-0.18738938868045807,0.153414785861969],[-0.18911269307136536,0.12984907627105713],[-0.31204909086227417,-0.004329681396484375],[-0.3646930456161499,-0.03723418712615967],[-0.2666911482810974,0.11191874742507935],[-0.42281925678253174,0.16498377919197083],[-0.39379581809043884,0.30932989716529846],[-0.2980071008205414,0.14795704185962677],[-0.36083996295928955,0.09252163767814636],[-0.3101460933685303,0.17930954694747925],[-0.39170363545417786,0.15618079900741577],[-0.45159903168678284,0.14780685305595398],[-0.42719510197639465,0.07266703248023987],[-0.4386264383792877,-0.017524659633636475],[-0.32720163464546204,0.053427860140800476],[-0.2893293499946594,0.025720521807670593],[-0.3666723370552063,-0.04913505166769028],[-0.5004075169563293,-0.012884195894002914],[-0.39016079902648926,0.009645894169807434],[-0.4109537601470947,0.05720248818397522],[-0.3058928847312927,0.17105025053024292],[-0.3632808327674866,0.14008109271526337],[-0.3511027693748474,0.07470696419477463],[-0.3476963937282562,0.08345851302146912],[-0.3646922707557678,0.044271647930145264],[-0.3639012575149536,0.15207470953464508],[-0.271235853433609,0.1563999354839325],[-0.3462851047515869,0.06457656621932983],[-0.25187966227531433,0.07413162291049957],[-0.21164488792419434,0.06751453876495361],[-0.23725548386573792,0.10128723084926605],[-0.18846070766448975,0.18300259113311768],[-0.2670634686946869,0.08377337455749512],[-0.26736879348754883,0.2050401270389557],[-0.10728779435157776,0.19655567407608032],[-0.20604169368743896,0.3302200734615326],[-0.1983698308467865,0.30555489659309387],[-0.1443079710006714,0.18905934691429138],[-0.20361225306987762,0.09030221402645111],[-0.15175317227840424,0.16434818506240845],[-0.1829715073108673,0.15316683053970337],[-0.19091373682022095,0.1145513653755188],[-0.012267768383026123,-0.015742003917694092],[-0.006689727306365967,-0.1274164617061615],[-0.008694231510162354,-0.052571818232536316],[-0.01194906234741211,-0.09164664149284363],[-0.07255366444587708,-0.05123676359653473],[-0.0666627287864685,-0.03316422551870346],[0.07923516631126404,-0.06542717665433884],[0.04214012622833252,-0.04245440661907196],[-0.05051295459270477,0.09154364466667175],[-0.01316995918750763,-0.06626486778259277],[-0.0647587776184082,-0.1934705376625061],[0.07386720180511475,-0.05619417130947113],[0.07891732454299927,-0.024669677019119263],[-0.02441824972629547,0.0156116783618927],[0.03356924653053284,0.014370173215866089],[0.11014409363269806,-0.19109302759170532],[0.03258329629898071,-0.03599517047405243],[0.0763186514377594,-0.028649628162384033],[-0.1339133083820343,-0.12185496091842651],[-0.2038523107767105,0.024148255586624146],[-0.007236674427986145,-0.053301483392715454],[-0.08636246621608734,-0.04340626299381256],[-0.08361351490020752,0.16813398897647858],[-0.13735610246658325,0.05463859438896179],[-0.2013307511806488,0.03644239902496338],[-0.1510659158229828,-0.01715102791786194],[-0.19468224048614502,-0.0052322447299957275],[-0.18888984620571136,0.01775762438774109],[-0.1872306913137436,-0.018710777163505554],[-0.14668254554271698,-0.13807255029678345],[-0.22173982858657837,-0.2835046052932739],[-0.12699821591377258,-0.18335506319999695],[-0.31234657764434814,-0.2630857825279236],[-0.3225659728050232,-0.008453518152236938],[-0.19853034615516663,-0.05361945927143097],[-0.20907458662986755,-0.20147673785686493],[-0.1325625777244568,-0.059078484773635864],[-0.045100390911102295,-0.04862247407436371],[-0.2364462912082672,-0.05225341022014618],[-0.2488478720188141,0.005567371845245361],[-0.18338099122047424,-0.17637236416339874],[-0.2257561981678009,-0.09457512199878693],[-0.1522175520658493,0.05134446918964386],[-0.22137294709682465,-0.06745350360870361],[-0.33427929878234863,-0.08847975730895996],[-0.2470770925283432,-0.18443571031093597],[-0.3167790472507477,-0.21840468049049377]]],\"text\":\"21314\",\"message\":\"上传并推理成功\",\"logits_real_fake\":[[0.2476905733346939,0.08862689137458801]]}\n"), true);
          System.out.println("上传成功" + analysisResponse);
          return analysisResponse;
    }

    private String storeFile(@NotNull(message = "图像不能为空") MultipartFile file) {
        if (file.isEmpty()) {
            throw new IllegalArgumentException("文件不能为空");
        }

        // 指定存储目录
        try {
            String uploadDir = String.valueOf(Paths.get("src/main/resources/images/").toAbsolutePath());
            File dir = new File(uploadDir);
            if (!dir.exists()) {
                dir.mkdirs();
            }

            // 生成唯一文件名
            String fileName = System.currentTimeMillis() + "_" + file.getOriginalFilename();
            String filePath = uploadDir + "\\" +fileName;
            System.out.println("fileName:" + fileName + "\nfilePath:" + filePath);
            // 存储文件
            file.transferTo(new File(filePath));

            return filePath;
        } catch (IOException e) {
            throw new RuntimeException("文件存储失败", e);
        }
    }
}
